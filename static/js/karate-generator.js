// Karate Feature File Generator JavaScript

let generatedFeature = '';

// Generate Karate Feature File
function generateKarateFeature() {
    // Get form values
    const featureName = document.getElementById('featureName').value.trim();
    const scenarioName = document.getElementById('scenarioName').value.trim();
    const httpMethod = document.getElementById('httpMethod').value;
    const endpoint = document.getElementById('endpoint').value.trim();
    const baseUrl = document.getElementById('baseUrl').value.trim();
    const expectedStatus = document.getElementById('expectedStatus').value;
    const requestPayload = document.getElementById('requestPayload').value.trim();
    const responsePayload = document.getElementById('responsePayload').value.trim();

    // Get advanced options
    const includeHeaders = document.getElementById('includeHeaders').checked;
    const includeAuth = document.getElementById('includeAuth').checked;
    const strictValidation = document.getElementById('strictValidation').checked;
    const includeComments = document.getElementById('includeComments').checked;

    // Validate inputs
    if (!featureName) {
        showModal('Validation Error', 'Feature name is required');
        return;
    }

    if (!scenarioName) {
        showModal('Validation Error', 'Scenario name is required');
        return;
    }

    if (!endpoint) {
        showModal('Validation Error', 'Endpoint path is required');
        return;
    }

    if (!responsePayload) {
        showModal('Validation Error', 'Response payload is required');
        return;
    }

    // Validate JSON payloads
    let requestJson = null;
    let responseJson = null;

    if (requestPayload) {
        try {
            requestJson = JSON.parse(requestPayload);
        } catch (e) {
            showModal('JSON Error', 'Invalid request JSON: ' + e.message);
            return;
        }
    }

    try {
        responseJson = JSON.parse(responsePayload);
    } catch (e) {
        showModal('JSON Error', 'Invalid response JSON: ' + e.message);
        return;
    }

    // Generate the feature file
    generatedFeature = buildKarateFeature({
        featureName,
        scenarioName,
        httpMethod,
        endpoint,
        baseUrl,
        expectedStatus,
        requestJson,
        responseJson,
        includeHeaders,
        includeAuth,
        strictValidation,
        includeComments
    });

    // Display the result
    document.getElementById('karateOutput').textContent = generatedFeature;
    document.getElementById('outputSection').style.display = 'block';

    // Scroll to output
    document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Build Karate Feature File Content
function buildKarateFeature(config) {
    let feature = '';

    // Feature header
    feature += `Feature: ${config.featureName}\n\n`;

    if (config.includeComments) {
        feature += `  # This feature file was auto-generated by Karate Feature Generator\n`;
        feature += `  # Date: ${new Date().toISOString().split('T')[0]}\n\n`;
    }

    // Background (optional)
    if (config.baseUrl || config.includeHeaders || config.includeAuth) {
        feature += `Background:\n`;

        if (config.baseUrl) {
            feature += `  * url '${config.baseUrl}'\n`;
        }

        if (config.includeHeaders) {
            feature += `  * configure headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' }\n`;
        }

        if (config.includeAuth) {
            if (config.includeComments) {
                feature += `  # Configure authentication - update with your auth method\n`;
            }
            feature += `  * header Authorization = 'Bearer YOUR_TOKEN_HERE'\n`;
        }

        feature += `\n`;
    }

    // Scenario
    feature += `Scenario: ${config.scenarioName}\n`;

    if (config.includeComments) {
        feature += `  # Arrange: Set up the request\n`;
    }

    // Set path
    feature += `  * def endpoint = '${config.endpoint}'\n`;

    // Set request body if present
    if (config.requestJson) {
        feature += `  * def requestBody =\n`;
        feature += `    """\n`;
        feature += indentJSON(config.requestJson, 4);
        feature += `    """\n`;
    }

    if (config.includeComments) {
        feature += `\n  # Act: Make the API call\n`;
    }

    // Make the request
    if (config.requestJson && ['POST', 'PUT', 'PATCH'].includes(config.httpMethod)) {
        feature += `  Given path endpoint\n`;
        feature += `  And request requestBody\n`;
        feature += `  When method ${config.httpMethod}\n`;
    } else {
        feature += `  Given path endpoint\n`;
        feature += `  When method ${config.httpMethod}\n`;
    }

    if (config.includeComments) {
        feature += `\n  # Assert: Validate the response\n`;
    }

    // Validate status code
    feature += `  Then status ${config.expectedStatus}\n`;

    // Validate response schema
    if (config.strictValidation) {
        feature += `  And match response ==\n`;
        feature += `    """\n`;
        feature += indentJSON(config.responseJson, 4);
        feature += `    """\n`;
    } else {
        feature += `  And match response contains\n`;
        feature += `    """\n`;
        feature += indentJSON(config.responseJson, 4);
        feature += `    """\n`;
    }

    // Add schema validation examples
    if (config.includeComments) {
        feature += `\n  # Additional validation examples (uncomment as needed):\n`;
        feature += `  # And match response.id == '#number'\n`;
        feature += `  # And match response.name == '#string'\n`;
        feature += `  # And match response.email == '#regex [a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}'\n`;
        feature += `  # And match each response.items == { id: '#number', name: '#string' }\n`;
    }

    return feature;
}

// Indent JSON for pretty printing in feature file
function indentJSON(json, spaces) {
    const jsonString = JSON.stringify(json, null, 2);
    const lines = jsonString.split('\n');
    return lines.map(line => ' '.repeat(spaces) + line).join('\n') + '\n';
}

// Format Request JSON
function formatRequestJSON() {
    const input = document.getElementById('requestPayload').value.trim();
    if (!input) {
        showModal('Info', 'Request payload is empty');
        return;
    }

    try {
        const parsed = JSON.parse(input);
        document.getElementById('requestPayload').value = JSON.stringify(parsed, null, 2);
    } catch (e) {
        showModal('JSON Error', 'Invalid JSON: ' + e.message);
    }
}

// Format Response JSON
function formatResponseJSON() {
    const input = document.getElementById('responsePayload').value.trim();
    if (!input) {
        showModal('Info', 'Response payload is empty');
        return;
    }

    try {
        const parsed = JSON.parse(input);
        document.getElementById('responsePayload').value = JSON.stringify(parsed, null, 2);
    } catch (e) {
        showModal('JSON Error', 'Invalid JSON: ' + e.message);
    }
}

// Clear Request
function clearRequest() {
    document.getElementById('requestPayload').value = '';
}

// Clear Response
function clearResponse() {
    document.getElementById('responsePayload').value = '';
}

// Clear All
function clearAll() {
    showConfirmModal('Clear All', 'Are you sure you want to clear all fields?', () => {
        document.getElementById('featureName').value = 'API Test';
        document.getElementById('scenarioName').value = 'Test API Endpoint';
        document.getElementById('httpMethod').value = 'GET';
        document.getElementById('endpoint').value = '/api/endpoint';
        document.getElementById('baseUrl').value = '';
        document.getElementById('expectedStatus').value = '200';
        document.getElementById('requestPayload').value = '';
        document.getElementById('responsePayload').value = '';
        document.getElementById('includeHeaders').checked = true;
        document.getElementById('includeAuth').checked = false;
        document.getElementById('strictValidation').checked = true;
        document.getElementById('includeComments').checked = true;
        document.getElementById('outputSection').style.display = 'none';
        generatedFeature = '';
    });
}

// Load Sample Data
function loadSampleData() {
    const sampleRequest = {
        "name": "John Doe",
        "email": "john.doe@example.com",
        "age": 30,
        "role": "developer"
    };

    const sampleResponse = {
        "id": 12345,
        "name": "John Doe",
        "email": "john.doe@example.com",
        "age": 30,
        "role": "developer",
        "status": "active",
        "createdAt": "2024-01-15T10:30:00Z",
        "updatedAt": "2024-01-15T10:30:00Z"
    };

    document.getElementById('featureName').value = 'User Management API';
    document.getElementById('scenarioName').value = 'Create a new user';
    document.getElementById('httpMethod').value = 'POST';
    document.getElementById('endpoint').value = '/api/users';
    document.getElementById('baseUrl').value = 'https://api.example.com';
    document.getElementById('expectedStatus').value = '201';
    document.getElementById('requestPayload').value = JSON.stringify(sampleRequest, null, 2);
    document.getElementById('responsePayload').value = JSON.stringify(sampleResponse, null, 2);

    showModal('Success', 'Sample data loaded successfully! Click "Generate Feature File" to see the result.');
}

// Copy to Clipboard
function copyToClipboard() {
    if (!generatedFeature) {
        showModal('Error', 'No feature file generated yet');
        return;
    }

    navigator.clipboard.writeText(generatedFeature).then(() => {
        showModal('Success', 'Feature file copied to clipboard!');
    }).catch(err => {
        showModal('Error', 'Failed to copy to clipboard: ' + err.message);
    });
}

// Download Feature File
function downloadFeatureFile() {
    if (!generatedFeature) {
        showModal('Error', 'No feature file generated yet');
        return;
    }

    const featureName = document.getElementById('featureName').value.trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');

    const filename = `${featureName || 'test'}.feature`;

    const blob = new Blob([generatedFeature], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showModal('Success', `Feature file downloaded as ${filename}`);
}

// Keyboard shortcuts
document.addEventListener('DOMContentLoaded', function() {
    // Ctrl/Cmd + Enter to generate
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            generateKarateFeature();
        }
    });

    // Auto-save to localStorage (optional feature)
    const inputs = ['featureName', 'scenarioName', 'httpMethod', 'endpoint', 'baseUrl', 'expectedStatus', 'requestPayload', 'responsePayload'];

    inputs.forEach(id => {
        const element = document.getElementById(id);

        // Load saved value
        const savedValue = localStorage.getItem(`karate_${id}`);
        if (savedValue && element.value === element.defaultValue) {
            element.value = savedValue;
        }

        // Save on change
        element.addEventListener('change', () => {
            localStorage.setItem(`karate_${id}`, element.value);
        });
    });
});
