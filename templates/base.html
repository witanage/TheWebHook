<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %}</title>

    <script>
        (function() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'system';
            let actualTheme = savedTheme;

            if (savedTheme === 'system') {
                actualTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            document.documentElement.setAttribute('data-theme', actualTheme);
        })();
    </script>

    <!-- Global Styles -->
    <link href="{{ url_for('static', filename='css/global-styles.css') }}" rel="stylesheet">

    {% block extra_head %}
    <!-- Page-specific styles and scripts go here -->
    {% endblock %}
</head>
<body>
<!-- Global Header with App Navigation -->
<div class="global-header">
    <div class="global-header-content">
        <div class="global-header-left">
            {% block header_left %}
            <!-- Back Button -->
            <button class="back-button" onclick="history.back()" title="Go Back">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Back
            </button>
            {% endblock %}
        </div>

        <div class="global-header-center">
            {% block header_center %}
            <h1 class="global-header-title">{% block page_title %}{{ self.title() }}{% endblock %}</h1>
            {% endblock %}
        </div>

        <div class="global-header-right">
            <!-- Connection Status (for webhook viewer) -->
            {% block connection_status %}{% endblock %}

            <!-- Notifications (optional, can be shown globally) -->
            {% block notifications %}{% endblock %}

            <!-- Admin Button (only for admin users) -->
            {% if is_admin %}
            <button class="admin-button" onclick="window.location.href='/admin/users'" title="Admin Panel">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                Admin
            </button>
            {% endif %}

            <!-- Profile Menu (Always visible) -->
            <div class="profile-menu">
                <button class="profile-button" onclick="toggleProfileMenu()">
                    <div class="profile-icon">{{ username[0].upper() if username else 'U' }}</div>
                    <span>{{ username if username else 'User' }}</span>
                    <span style="font-size: 12px;">‚ñº</span>
                </button>
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-item" onclick="openPasswordModal()">
                        <span>üîê</span>
                        <span>Change Password</span>
                    </div>
                    <div class="profile-dropdown-item">
                        <span>üé®</span>
                        <span>Theme</span>
                        <select class="theme-select-inline" id="themeSelect" onclick="event.stopPropagation()"
                                onchange="changeTheme(this.value)">
                            <option value="system">System</option>
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                    </div>
                    <div class="profile-dropdown-item" onclick="openAboutModal()">
                        <span>‚ÑπÔ∏è</span>
                        <span>About</span>
                    </div>
                    <div class="profile-dropdown-item danger" onclick="openLogoutModal()">
                        <span>üö™</span>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<main class="main-content">
    {% block content %}
    {% endblock %}
</main>

<!-- Password Change Modal -->
<div class="modal-overlay" id="passwordModal">
    <div class="modal modal-confirmation">
        <h3>Change Password</h3>
        <form id="passwordForm" onsubmit="changePassword(event)">
            <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" required>
            </div>
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" required minlength="6">
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" required minlength="6">
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closePasswordModal()">Cancel</button>
                <button type="submit" class="btn-primary">Change Password</button>
            </div>
        </form>
    </div>
</div>

<!-- Logout Confirmation Modal -->
<div class="modal-overlay" id="logoutModal">
    <div class="modal modal-confirmation">
        <div class="modal-icon warning">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2">
                <path d="M10 17l5-5-5-5"/>
                <path d="M20 12H4"/>
            </svg>
        </div>
        <h3>Confirm Logout</h3>
        <p class="modal-message">Are you sure you want to logout?</p>
        <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="closeLogoutModal()">Cancel</button>
            <button type="button" class="btn-danger" onclick="confirmLogout()">Logout</button>
        </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal-overlay" id="aboutModal">
    <div class="modal modal-large">
        <div class="modal-header">
            <h3>About</h3>
            <button class="modal-close" onclick="closeAboutModal()">‚úï</button>
        </div>
        <div class="modal-content">
            <p>Developer Tools Dashboard</p>
            <p>Version 1.0</p>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="closeAboutModal()">Close</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<!-- Generic Alert Modal -->
<div class="modal-overlay" id="genericAlertModal">
    <div class="modal modal-confirmation">
        <div class="modal-icon info" id="alertModalIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        </div>
        <h3 id="alertModalTitle">Alert</h3>
        <p class="modal-message" id="alertModalMessage"></p>
        <div class="form-actions">
            <button type="button" class="btn-primary" id="alertModalOkBtn">OK</button>
        </div>
    </div>
</div>

<!-- Generic Confirmation Modal -->
<div class="modal-overlay" id="genericConfirmModal">
    <div class="modal modal-confirmation">
        <div class="modal-icon warning" id="confirmModalIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        </div>
        <h3 id="confirmModalTitle">Confirm</h3>
        <p class="modal-message" id="confirmModalMessage"></p>
        <div class="form-actions">
            <button type="button" class="btn-secondary" id="confirmModalCancelBtn">Cancel</button>
            <button type="button" class="btn-danger" id="confirmModalConfirmBtn">Confirm</button>
        </div>
    </div>
</div>

<!-- Global Scripts -->
<script src="{{ url_for('static', filename='js/modal-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/global-functions.js') }}"></script>

{% block extra_scripts %}
<!-- Page-specific scripts go here -->
{% endblock %}
</body>
</html>