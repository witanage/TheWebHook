{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/menu.css') }}" rel="stylesheet">
{% endblock %}

{% block header_left %}
<!-- Empty - no back button on menu page -->
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <p>Select a tool to get started</p>
    </div>

    <div class="tools-grid">
        {% for item in menu_items %}
        <div class="tool-card" data-route="{{ item.route }}" onclick="navigateToCard(event, '{{ item.route }}')">
            <div class="default-app-selector">
                <input type="radio"
                       name="defaultApp"
                       id="default_{{ loop.index }}"
                       value="{{ item.route }}"
                       onclick="handleRadioClick(event, '{{ item.route }}')">
                <label for="default_{{ loop.index }}" title="Set as default application"></label>
            </div>
            <span class="tool-icon">{{ item.icon }}</span>
            <h2 class="tool-title">{{ item.title }}</h2>
            <p class="tool-description">{{ item.description }}</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Track the currently selected radio button value
    let currentlySelected = null;

    // Load and set the default app radio button on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Get default app from server-side template variable
        const defaultApp = {{ default_app|tojson }};

        // Set radio button if default app is selected
        if (defaultApp) {
            const radioButton = document.querySelector(`input[name="defaultApp"][value="${defaultApp}"]`);
            if (radioButton) {
                radioButton.checked = true;
                currentlySelected = defaultApp;
            }
        }
    });

    // Function to handle radio button clicks (allows toggle on/off)
    function handleRadioClick(event, route) {
        event.stopPropagation();

        const radioButton = event.target;

        // If clicking the already selected radio button, deselect it
        if (currentlySelected === route && radioButton.checked) {
            radioButton.checked = false;
            currentlySelected = null;
            setDefaultApp('');  // Clear the default app
        } else {
            // Select the new radio button
            currentlySelected = route;
            setDefaultApp(route);
        }
    }

    // Function to set default application (saves to database)
    function setDefaultApp(route) {
        fetch('/api/set-default-app', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ default_app: route })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                if (route) {
                    console.log('Default app set to:', route);
                } else {
                    console.log('Default app cleared');
                }
            } else if (data.error) {
                console.error('Error setting default app:', data.error);
                alert('Failed to set default app: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to set default app. Please try again.');
        });
    }

    // Function to navigate to card (handles card click without interfering with radio button)
    function navigateToCard(event, route) {
        // Don't navigate if clicking on radio button or its label
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'LABEL') {
            return;
        }
        window.location.href = route;
    }
</script>
{% endblock %}